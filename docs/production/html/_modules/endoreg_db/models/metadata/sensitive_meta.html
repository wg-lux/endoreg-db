

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>endoreg_db.models.metadata.sensitive_meta &mdash; EndoReg-DB  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            EndoReg-DB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html">Models Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.administration.ai">AI Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.administration.case">Case</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.administration.center">Center</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.administration.person">Person</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-0">Product</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.label">Label</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.media.video">Video</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.media.frame">Frame</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#report">Report</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.disease">Disease</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.event">Event</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.patient">Patient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.finding">Finding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.risk">Risk</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.hardware">Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.laboratory">Laboratory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.medical.organ">Organ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#module-endoreg_db.models.metadata">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#requirement">Requirement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#state">State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../models.html#other">Other</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">EndoReg-DB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">endoreg_db.models.metadata.sensitive_meta</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for endoreg_db.models.metadata.sensitive_meta</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="c1"># Removed hash utils, datetime, random, os, timezone, sha256 imports</span>
<span class="c1"># Removed icecream import (was used in old save logic)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Type</span>

<span class="c1"># Import logic functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">sensitive_meta_logic</span> <span class="k">as</span> <span class="n">logic</span>
<span class="c1"># Import models needed for type hints and FKs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..state</span><span class="w"> </span><span class="kn">import</span> <span class="n">SensitiveMetaState</span> <span class="c1"># Needed for post-save state check</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..administration</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">Center</span><span class="p">,</span>
        <span class="n">Examiner</span><span class="p">,</span>
        <span class="n">Patient</span><span class="p">,</span>
        <span class="n">FirstName</span><span class="p">,</span> <span class="c1"># Keep for type hinting if needed</span>
        <span class="n">LastName</span>   <span class="c1"># Keep for type hinting if needed</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..other</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gender</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..medical</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatientExamination</span>
    <span class="c1"># from ..state import SensitiveMetaState # Already imported above</span>


<span class="c1"># SECRET_SALT moved to logic</span>

<div class="viewcode-block" id="SensitiveMeta">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SensitiveMeta</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores potentially sensitive information extracted from media.</span>
<span class="sd">    Logic for creation, hashing, pseudo-anonymization, and saving is in sensitive_meta_logic.py.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">examination_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pseudo_patient</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;Patient&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;FK to the pseudo-anonymized Patient record.&quot;</span>
    <span class="p">)</span>
    <span class="n">patient_first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">patient_last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">patient_dob</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date of birth (can be auto-generated if missing).&quot;</span>
    <span class="p">)</span>
    <span class="n">pseudo_examination</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;PatientExamination&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;FK to the pseudo-anonymized PatientExamination record.&quot;</span>
    <span class="p">)</span>
    <span class="n">patient_gender</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;Gender&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">examiners</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="s2">&quot;Examiner&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Pseudo-anonymized examiner(s) associated with the examination.&quot;</span>
    <span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;Center&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># Should ideally be False if always required before save</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Should ideally be False</span>
    <span class="p">)</span>

    <span class="c1"># Raw examiner names stored temporarily until pseudo-examiner is created/linked</span>
    <span class="n">examiner_first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">examiner_last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Hashes calculated and stored by save logic</span>
    <span class="n">examination_hash</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Use 64 for sha256 hex</span>
    <span class="n">patient_hash</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Use 64 for sha256 hex</span>

    <span class="n">endoscope_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">endoscope_sn</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Removed state_verified property, assuming state is handled via the related SensitiveMetaState model</span>

    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="n">examiners</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">[</span><span class="s2">&quot;Examiner&quot;</span><span class="p">]</span>
        <span class="n">pseudo_patient</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span>
        <span class="n">patient_gender</span><span class="p">:</span> <span class="s2">&quot;Gender&quot;</span>
        <span class="n">pseudo_examination</span><span class="p">:</span> <span class="s2">&quot;PatientExamination&quot;</span>
        <span class="n">state</span><span class="p">:</span> <span class="s2">&quot;SensitiveMetaState&quot;</span> <span class="c1"># Assuming related_name=&#39;state&#39; is defined on SensitiveMetaState.origin</span>
        <span class="n">center</span><span class="p">:</span> <span class="s2">&quot;Center&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_random_dob</span><span class="p">():</span>
        <span class="c1"># Delegate to logic</span>
        <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">generate_random_dob</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_random_examination_date</span><span class="p">():</span>
        <span class="c1"># Delegate to logic</span>
        <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">generate_random_examination_date</span><span class="p">()</span>

<div class="viewcode-block" id="SensitiveMeta.create_from_dict">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.create_from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;SensitiveMeta&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a SensitiveMeta instance from a dictionary using external logic.&quot;&quot;&quot;</span>
        <span class="c1"># Delegate to logic function</span>
        <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">create_sensitive_meta_from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>


    <span class="c1"># --- Methods related to pseudo-entities are now primarily handled within save logic ---</span>
    <span class="c1"># Keep simple getters if needed, but creation logic is centralized.</span>

<div class="viewcode-block" id="SensitiveMeta.get_pseudo_examiner">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.get_pseudo_examiner">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pseudo_examiner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Examiner | None&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the linked pseudo examiner, if one exists.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">examiners</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Cannot determine before saving and linking</span></div>


    <span class="c1"># Removed create_pseudo_examiner - logic is now in sensitive_meta_logic.create_pseudo_examiner_logic</span>

<div class="viewcode-block" id="SensitiveMeta.get_pseudo_patient">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.get_pseudo_patient">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pseudo_patient</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Patient | None&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the linked pseudo patient, if one exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_patient</span> <span class="c1"># Access the FK directly</span></div>


    <span class="c1"># Removed create_pseudo_patient - logic is now in sensitive_meta_logic.get_or_create_pseudo_patient_logic</span>

<div class="viewcode-block" id="SensitiveMeta.get_pseudo_patient_examination">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.get_pseudo_patient_examination">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pseudo_patient_examination</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;PatientExamination | None&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the linked pseudo patient examination, if one exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_examination</span> <span class="c1"># Access the FK directly</span></div>


    <span class="c1"># Removed get_or_create_pseudo_patient_examination - logic is now in sensitive_meta_logic.get_or_create_pseudo_patient_examination_logic</span>

    <span class="c1"># --- Update method delegates to logic ---</span>
<div class="viewcode-block" id="SensitiveMeta.update_from_dict">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.update_from_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the instance from a dictionary using external logic.&quot;&quot;&quot;</span>
        <span class="c1"># Delegate to logic function</span>
        <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">update_sensitive_meta_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>


    <span class="c1"># --- String representation ---</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Keep this method for basic representation, ensure fields are accessed safely</span>
        <span class="n">center_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">gender_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_gender</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_gender</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">dob_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_dob</span><span class="o">.</span><span class="n">date</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_dob</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span> <span class="c1"># Show only date part</span>
        <span class="n">exam_date_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examination_date</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">examination_date</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>

        <span class="n">examiners_str</span> <span class="o">=</span> <span class="s2">&quot;[Not saved yet]&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Use prefetch_related in queries accessing this for efficiency</span>
                <span class="n">examiners_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">examiners</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span> <span class="ow">or</span> <span class="s2">&quot;[None]&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">examiners_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">state_verified</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Access state verification through the related state object</span>
                <span class="n">state_verified</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_verified</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="k">else</span> <span class="s2">&quot;No State&quot;</span>
            <span class="k">except</span> <span class="n">SensitiveMetaState</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                 <span class="n">state_verified</span> <span class="o">=</span> <span class="s2">&quot;No State&quot;</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                 <span class="c1"># Handle case where &#39;state&#39; related name isn&#39;t set up or instance not saved</span>
                 <span class="n">state_obj</span> <span class="o">=</span> <span class="n">SensitiveMetaState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">origin_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                 <span class="n">state_verified</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">state_obj</span><span class="o">.</span><span class="n">is_verified</span><span class="p">)</span> <span class="k">if</span> <span class="n">state_obj</span> <span class="k">else</span> <span class="s2">&quot;No State&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_verified</span> <span class="o">=</span> <span class="s2">&quot;[Not saved yet]&quot;</span>


        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SensitiveMeta(pk=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">): &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Patient=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_last_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_first_name</span><span class="si">}</span><span class="s2"> (*</span><span class="si">{</span><span class="n">dob_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">gender_str</span><span class="si">}</span><span class="s2">), &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ExamDate=</span><span class="si">{</span><span class="n">exam_date_str</span><span class="si">}</span><span class="s2">, Center=</span><span class="si">{</span><span class="n">center_name</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Examiners=</span><span class="si">{</span><span class="n">examiners_str</span><span class="si">}</span><span class="s2">, StateVerified=</span><span class="si">{</span><span class="n">state_verified</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;PatientHash=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_hash</span><span class="p">)[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">patient_hash</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">, &quot;</span> <span class="c1"># Show last 8 chars</span>
            <span class="sa">f</span><span class="s2">&quot;ExamHash=</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">examination_hash</span><span class="p">)[</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">examination_hash</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1"># Show last 8 chars</span>
        <span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="c1"># --- Hashing methods delegate to logic ---</span>
<div class="viewcode-block" id="SensitiveMeta.get_patient_hash">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.get_patient_hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_patient_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the patient hash using external logic.&quot;&quot;&quot;</span>
        <span class="c1"># Use default salt from logic if None is passed</span>
        <span class="n">salt_to_use</span> <span class="o">=</span> <span class="n">salt</span> <span class="k">if</span> <span class="n">salt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logic</span><span class="o">.</span><span class="n">SECRET_SALT</span>
        <span class="c1"># Delegate to logic function</span>
        <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">calculate_patient_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt_to_use</span><span class="p">)</span></div>


<div class="viewcode-block" id="SensitiveMeta.get_patient_examination_hash">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.get_patient_examination_hash">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_patient_examination_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates the examination hash using external logic.&quot;&quot;&quot;</span>
        <span class="n">salt_to_use</span> <span class="o">=</span> <span class="n">salt</span> <span class="k">if</span> <span class="n">salt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">logic</span><span class="o">.</span><span class="n">SECRET_SALT</span>
        <span class="c1"># Delegate to logic function</span>
        <span class="k">return</span> <span class="n">logic</span><span class="o">.</span><span class="n">calculate_examination_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt_to_use</span><span class="p">)</span></div>


    <span class="c1"># --- Save method orchestrates calls to logic ---</span>
<div class="viewcode-block" id="SensitiveMeta.save">
<a class="viewcode-back" href="../../../../models.html#endoreg_db.models.metadata.SensitiveMeta.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the default save method to ensure data integrity, calculate hashes,</span>
<span class="sd">        link pseudo-entities, and manage related state using external logic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Call the main logic function to perform pre-save checks, data generation,</span>
        <span class="c1">#    and creation/linking of pseudo patient/examination FKs.</span>
        <span class="c1">#    This function modifies the instance fields (hashes, FKs, dates).</span>
        <span class="c1">#    It returns the examiner instance to be linked *after* saving.</span>
        <span class="n">examiner_to_link</span> <span class="o">=</span> <span class="n">logic</span><span class="o">.</span><span class="n">perform_save_logic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c1"># Pass only self</span>

        <span class="c1"># 2. Call the original Django save method to save the instance itself</span>
        <span class="c1">#    (including updated FKs, hashes, dates).</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># Pass original args/kwargs</span>

        <span class="c1"># 3. Ensure SensitiveMetaState exists *after* saving the main instance</span>
        <span class="c1">#    Use related name &#39;state&#39; if defined, otherwise access via manager.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span> <span class="c1"># Ensure we have a PK</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check if the related state object already exists using the related manager</span>
                <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
            <span class="k">except</span> <span class="n">SensitiveMetaState</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="c1"># If not, create a new one, linking it to the saved instance</span>
                <span class="n">SensitiveMetaState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                 <span class="c1"># Fallback check if &#39;state&#39; related_name is missing</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">SensitiveMetaState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                      <span class="n">SensitiveMetaState</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">origin</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># 4. Handle ManyToMany linking (examiners) *after* the instance has a PK.</span>
        <span class="k">if</span> <span class="n">examiner_to_link</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">examiners</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">examiner_to_link</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">examiners</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">examiner_to_link</span><span class="p">)</span></div>

            <span class="c1"># Adding to M2M handles its own DB interaction, no second super().save() needed.</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_update_name_db</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">):</span>
        <span class="c1"># Delegate to logic</span>
        <span class="n">logic</span><span class="o">.</span><span class="n">update_name_db</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1980, AG-Lux.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>